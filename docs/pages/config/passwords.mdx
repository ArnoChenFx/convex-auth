import { Steps } from "nextra/components";

# Passwords

You can implement email or username and password sign-in, and other sign-in
methods, via the `Password` or `ConvexCredentials` providers.

Proper password-based authentication system requires at minimum a way for the
user to reset their password (usually via email or text).

You might also want to require email verification (during initial sign up or
afterwards) to prevent users from accidentally or maliciously using the wrong
email.

## Email + password setup

<Steps>

### Provider configuration

Add the provider to the `providers` array in `convex/auth.ts`.

You can import the `Password` provider from
`@xixixao/convex-auth/providers/Password`:

```ts filename="convex/auth.ts"
import Password from "@xixixao/convex-auth/providers/password";
import { convexAuth } from "@xixixao/convex-auth";

export const { providers, signIn, signOut, verifyCode, store, auth } =
  convexAuth({
    providers: [Password],
  });
```

### Add sign-in form

Now you can trigger sign up or sign in from a form submission via the `signIn`
function.

The first argument to the function is the provider ID, which unless customized
is a lowercase version of the provider name, in this case `password`.

The Password provider included in `@xixixao/convex-auth` assumes that the
sign-up and sign-in flows are separate - this can prevent some user confusion
during errors.

```tsx filename="src/SignIn.tsx"
"use client";

import { useConvexAuthClient } from "@xixixao/convex-auth/react";

export function SignIn() {
  const { signIn, verifyCode } = useConvexAuthClient();
  const [step, setStep] = useState<"signUp" | "signIn">("signIn");
  return (
    <form
      onSubmit={(event) => {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        formData.set("flow", flow);
        void signIn("password", formData);
      }}
    >
      <input name="email" placeholder="Email" type="text" />
      <input name="password" placeholder="Password" type="password" />
      <button type="submit">{flow === "signIn" ? "Sign in" : "Sign up"}</button>
      <button
        type="button"
        onClick={() => {
          setFlow(flow === "signIn" ? "signUp" : "signIn");
        }}
      >
        {flow === "signIn" ? "Sign up instead" : "Sign in instead"}
      </button>
    </form>
  );
}
```

Check out the [example repo](#) for a more polished UI.

</Steps>

When you're done configuring your chosen authentication methods, learn how to
use authentication in your frontend and backend in [Authorization](/authz).

## Email reset setup

Email reset is essentially a completely separate sign-in flow with two steps:

1. The user requests a password reset link/code to be sent to their email
   address
2. The user either clicks on the link or fills out the code on the website, and
   also fills out a new password

This is very similar to the [Magic Links & OTPs](/config/email) authentication
method, and the implementation will also be similar.

Note that password reset via a link will require you to implement some form of
routing so that your app knows that it should be rendering the 2nd password
reset step.

<Steps>

### Provider configuration

The `Password` provider included in Convex Auth supports password reset flow via
the `reset` option, which takes an Auth.js email provider.

First, create a custom email provider.

This example send an OTP code and uses:

1. Resend and its SDK
2. Oslo, a handy library which is part of the Lucia project

You can install these with `npm i resend oslo`.

```ts convex/ResendOTPPasswordReset.ts
import Resend from "@auth/core/providers/resend";
import { Resend as ResendAPI } from "resend";
import { alphabet, generateRandomString } from "oslo/crypto";

export const ResendOTP = Resend({
  id: "resend-otp",
  async generateVerificationToken() {
    return generateRandomString(8, alphabet("0-9"));
  },
  async sendVerificationRequest({ identifier: email, provider, token }) {
    const resend = new ResendAPI(provider.apiKey);
    const { error } = await resend.emails.send({
      from: "My App <onboarding@resend.dev>",
      to: [email],
      subject: `Reset your password in My App`,
      text: "Your password reset code is " + token,
    });

    if (error) {
      throw new Error("Could not send");
    }
  },
});
```

Then use it in `convex/auth.ts`:

```ts filename="convex/auth.ts"
import Password from "@xixixao/convex-auth/providers/password";
import { convexAuth } from "@xixixao/convex-auth";
import { ResendOTPPasswordReset } from "./ResendOTPPasswordReset";

export const { providers, signIn, signOut, verifyCode, store, auth } =
  convexAuth({
    providers: [Password({ reset: ResendOTPPasswordReset })],
  });
```

### Add password reset form

The Password provider included in `@xixixao/convex-auth` expects the password
reset flow to be indicated via the `flow` field (just like the sign-up and
sign-in flows were).

```tsx filename="src/PasswordReset.tsx"
"use client";

import { useConvexAuthClient } from "@xixixao/convex-auth/react";

export function PasswordReset() {
  const { signIn, verifyCode } = useConvexAuthClient();
  const [step, setStep] = useState<"forgot" | "reset">("forgot");
  return step === "forgot" ? (
    <form
      onSubmit={(event) => {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        void signIn("password", formData).then(() => setStep("reset"));
      }}
    >
      <input name="email" placeholder="Email" type="text" />
      <input type="hidden" name="flow" value="reset" />
      <button type="submit">Send code</button>
    </form>
  ) : (
    <form
      onSubmit={(event) => {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        void verifyCode("password", formData);
      }}
    >
      <input name="code" placeholder="Code" type="text" />
      <input name="newPassword" placeholder="New password" type="password" />
      <input type="hidden" name="flow" value="reset" />
      <button type="submit">Continue</button>
      <button type="button" onClick={() => setStep("signIn")}>
        Cancel
      </button>
    </form>
  );
}
```

</Steps>

## Customize email and password validation

You'll want to improve the input validation for your sign-up form. Some
suggestions:

- Use [Zod](https://zod.dev/) to validate basics like email format and password
  length, and share the logic between client and backend
- Use [haveibeenpwned](https://haveibeenpwned.com/) to check whether the email
  the user wants to use has been previously leaked
- Use [zxcvbn-ts](https://zxcvbn-ts.github.io/zxcvbn/) to require a minimum
  password strength

To do this, you can pass the `profile` option to `Password`:

```ts filename="CustomPassword.ts"
import Password from "@xixixao/convex-auth/providers/password";
import { z } from "zod";

const ParamsSchema = z.object({
  email: z.string().email(),
  password: z.string().min(16),
});

export default Password({
  profile(params) {
    const { error, data } = ParamsSchema.safeParse(params);
    if (error) {
      throw new ConvexError(error.format());
    }
    return { email: data.email };
  },
});
```

## Customize user information

Your sign-up form can include additional fields, and you can write these to your
`users` documents.

To do this, you need to:

1. [Customize the schema](/setup/schema) to define the additional fields
2. Return the additional fields from the `profile` method

```ts filename="CustomPassword.ts"
import Password from "@xixixao/convex-auth/providers/password";
import { DataModel } from "./_generated/dataModel";

export default Password<DataModel>({
  profile(params) {
    return {
      email: params.email as string,
      name: params.name as string,
      role: params.role as string,
    };
  },
});
```

Parametrizing `Password` with your `DataModel` gives you strict type checking
for the return value of `profile`.
