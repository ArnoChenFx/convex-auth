import { Steps } from "nextra/components";
import { Aside } from "../../../components/Aside";

# OTPs

This authentication method has two steps:

1. The user provides an email, to which a one-time-password (OTP) code is sent
2. The user then fills out the code within your app

Your database keeps track of the issued code that was sent which allows for
secure verification and expiration.

You will configure your own email template, so you can send an OTP and a
[magic link](/config/email) together.

## Email providers

Convex Auth implements configuration via [Auth.js](https://authjs.dev)
"provider" configs. These JS objects define how the library sends emails.

Open the
[Auth.js Magic Links providers doc](https://authjs.dev/getting-started/authentication/email)
to see a list of available email providers.

Choose an email provider (for example _Resend_) and follow the guide below.

_Ignore the "database provider" configuration in Auth.js docs. Your Convex
backend is your database!_

## Setup

<Steps>

### Environment variables

Configure the relevant environment variables for a given email provider, as per
Auth.js docs, on your Convex backend.

See
[setting environment variables Convex docs](https://docs.convex.dev/production/environment-variables#setting-environment-variables).

For example for _Resend_, after you sign up and obtain your API key, you can run
(with your own value):

```sh
npx convex env set AUTH_RESEND_KEY yourresendkey
```

### Provider configuration

Create a custom provider config for sending an OTP.

<Aside title="This example uses additional dependencies">

1. The Resend SDK (`resend` on NPM)
2. `oslo`, a handy library which is part of the Lucia project

You can install these with `npm i resend oslo`.

</Aside>

```ts filename="convex/ResendOTP.ts"
import Resend from "@auth/core/providers/resend";
import { Resend as ResendAPI } from "resend";
import { alphabet, generateRandomString } from "oslo/crypto";

export const ResendOTP = Resend({
  id: "resend-otp",
  async generateVerificationToken() {
    return generateRandomString(8, alphabet("0-9"));
  },
  async sendVerificationRequest({ identifier: email, provider, token }) {
    const resend = new ResendAPI(provider.apiKey);
    const { error } = await resend.emails.send({
      from: "My App <onboarding@resend.dev>",
      to: [email],
      subject: `Sign in to My App`,
      text: "Your code is " + token,
    });

    if (error) {
      throw new Error("Could not send");
    }
  },
});
```

Then use it in `convex/auth.ts`:

```ts filename="convex/auth.ts"
import { convexAuth } from "@xixixao/convex-auth/server";
import { ResendOTP } from "./ResendOTP";

export const { auth, signIn, verifyCode, signOut, store } = convexAuth({
  providers: [ResendOTP],
});
```

Check out the
[example repo](https://github.com/xixixao/convex-auth/blob/convex-auth-demo-src/convex/otp/ResendOTP.ts)
for a more polished email template, including using `React` for the email
templating (add `"jsx": "react-jsx"` to your `convex/tsconfig.json`).

You can find more examples of email customization in
[Auth.js docs](https://authjs.dev/getting-started/providers/resend#customization).

<details>
  <summary>
    To send both a magic link and an OTP, include a link with `?code={token}`
    query string to your web app in your email template.
  </summary>
  Security note: This will make the magic link use a short token (the same as the
  OTP), which is less secure.
</details>

### Add sign-in form

Now you can trigger the email sending from a form submission via the `signIn`
function.

After the email is sent, you should show the second form for submitting the
code, which can be done via the `verifyCode` function.

For example for the custom `ResendOTP` provider:

```tsx filename="src/SignIn.tsx"
"use client";

import { useAuthActions } from "@xixixao/convex-auth/react";

export function SignIn() {
  const { signIn, verifyCode } = useAuthActions();
  const [step, setStep] = useState<"signIn" | "code">("signIn");
  return step === "signIn" ? (
    <form
      onSubmit={(event) => {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        void signIn("resend-otp", formData).then(() => setStep("code"));
      }}
    >
      <input name="email" placeholder="Email" type="text" />
      <button type="submit">Send code</button>
    </form>
  ) : (
    <form
      onSubmit={(event) => {
        event.preventDefault();
        const formData = new FormData(event.currentTarget);
        void verifyCode("resend-otp", formData);
      }}
    >
      <input name="code" placeholder="Code" type="text" />
      <button type="submit">Continue</button>
      <button type="button" onClick={() => setStep("signIn")}>
        Cancel
      </button>
    </form>
  );
}
```

Check out the
[example repo](https://github.com/xixixao/convex-auth/blob/convex-auth-demo-src/app/auth/SignInFormEmailCode.tsx)
for a more polished UI.

</Steps>

When you're done configuring your chosen authentication methods, learn how to
use authentication in your frontend and backend in [Authorization](/authz).
