# server

Configuration and helpers for using Convex Auth on your Convex
backend.

Call [convexAuth](server.mdx#convexauth) to configure your authentication methods
and use the helpers it returns.

Include [authTables](server.mdx#authtables) in your schema.

## authTables


The table definitions required by the library.

Your schema must include these so that the indexes
are set up:

```ts filename="convex/schema.ts"
import { defineSchema } from "convex/server";
import { authTables } from "@xixixao/convex-auth/server";

const schema = defineSchema({
  ...authTables,
});

export default schema;
```

You can inline the table definitions into your schema
and extend them with additional optional and required
fields. See https://labs.convex.dev/auth/setup/schema
for more details.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Type declaration</h3>

#### users


Users.

|Field|TS Type
|---|---
|`name`|  `undefined` \| `string`
|`image`|  `undefined` \| `string`
|`emailVerificationTime`|  `undefined` \| `number`
|`email`|  `string`
|`\_creationTime`|  `number`

#### sessions


Sessions.
A single user can have multiple active sessions.
See [Session document lifecycle](https://labs.convex.dev/auth/advanced#session-document-lifecycle).

|Field|TS Type
|---|---
|`userId`|  `Id`\<`"users"`\>
|`expirationTime`|  `number`
|`\_creationTime`|  `number`

#### accounts


Accounts. An account corresponds to
a single authentication provider.
A single user can have multiple accounts linked.

|Field|TS Type
|---|---
|`secret`|  `undefined` \| `string`
|`type`|  `"credentials"` \| `"email"` \| `"oauth"` \| `"webauthn"` \| `"oidc"`
|`userId`|  `Id`\<`"users"`\>
|`provider`|  `string`
|`providerAccountId`|  `string`
|`emailVerified`|  `boolean`
|`\_creationTime`|  `number`

#### refreshTokens


Refresh tokens.
Each session has only a single refresh token
valid at a time. Refresh tokens are rotated
and reuse is not allowed.

|Field|TS Type
|---|---
|`userId`|  `Id`\<`"users"`\>
|`expirationTime`|  `number`
|`sessionId`|  `Id`\<`"sessions"`\>
|`\_creationTime`|  `number`

#### verificationCodes


Verification codes:
- OTP tokens
- magic link tokens
- OAuth codes

|Field|TS Type
|---|---
|`emailVerified`|  `undefined` \| `boolean`
|`verifier`|  `undefined` \| `string`
|`expirationTime`|  `number`
|`accountId`|  `Id`\<`"accounts"`\>
|`code`|  `string`
|`\_creationTime`|  `number`

#### verifiers


PKCE verifiers.

|Field|TS Type
|---|---
|`state`|  `string`
|`verifier`|  `string`
|`\_creationTime`|  `number`

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:77](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L77)

***

## convexAuth()


Configure the Convex Auth library. Returns an object with
functions and `auth` helper. You must export the functions
from `convex/auth.ts` to make them callable:

```ts filename="convex/auth.ts"
import { convexAuth } from "@xixixao/convex-auth/server";

export const { auth, signIn, verifyCode, signOut, store } = convexAuth({
  providers: [],
});
```

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type |
| :------ | :------ |
| `config_` | [`ConvexAuthConfig`](server.mdx#convexauthconfig) |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`object`

An object with `auth` helper for configuring HTTP actions and accessing
the current user and session ID.

#### auth


#### auth.getUserId()


Return the currently signed-in user's ID.

```ts filename="convex/myFunctions.tsx"
import { mutation } from "./_generated/server";
import { auth } from "./auth";

export const currentUser = mutation({
  args: {/* ... */},
  handler: async (ctx, args) => {
    const userId = await auth.getUserId(ctx);
    if (userId === null) {
      throw new Error("User is not authenticated!")
    }
    const user = await ctx.db.get(userId);
    // ...
  },
});
```

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Parameters</h5>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `object` | query, mutation or action `ctx` |
| `ctx.auth` | `Auth` | - |

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Returns</h5>

`Promise`\<`null` \| `Id`\<`"users"`\>\>

#### auth.getSessionId()


Return the current session ID.

```ts filename="convex/myFunctions.tsx"
import { mutation } from "./_generated/server";
import { auth } from "./auth";

export const currentSession = mutation({
  args: {/* ... */},
  handler: async (ctx, args) => {
    const sessionId = await auth.getSessionId(ctx);
    if (sessionId === null) {
      throw new Error("Session is not authenticated!")
    }
    const session = await ctx.db.get(sessionId);
    // ...
  },
});
```

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Parameters</h5>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `object` | query, mutation or action `ctx` |
| `ctx.auth` | `Auth` | - |

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Returns</h5>

`Promise`\<`null` \| `Id`\<`"sessions"`\>\>

#### auth.addHttpRoutes()


Add HTTP actions for JWT verification and OAuth sign-in.

```ts
import { httpRouter } from "convex/server";
import { auth } from "./auth";

const http = httpRouter();

auth.addHttpRoutes(http);

export default http;
```

The following routes are handled always:

- `/.well-known/openid-configuration`
- `/.well-known/jwks.json`

The following routes are handled if OAuth is configured:

- `/api/auth/signin/*`
- `/api/auth/callback/*`

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Parameters</h5>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `http` | `HttpRouter` | your HTTP router |

<h5 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-lg">Returns</h5>

`void`

#### signIn


Action called by the client to sign the user in.

#### verifyCode


Action called by the client to complete sign via code verification.

#### signOut


Action called by the client to invalidate the current session.

#### store


Internal mutation used by the library to read and write
to the database during signin and signout.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:282](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L282)

***

## createAccountWithCredentials()


Use this function from a `ConvexCredentials` provider
to create an account and a user with a pair of unique
id and an account secret.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `GenericActionCtx`\<`DataModel`\> | - |
| `args` | `object` | - |
| `args.provider` | `string` | <p>The provider ID (like "password"), used to disambiguate accounts.</p><p>It is also used to configure account secret hashing via the provider's `crypto` option.</p> |
| `args.account` | `object` | - |
| `args.account.id` | `string` | The unique external ID for the account, for example email address. |
| `args.account.secret` | `string` | The secret credential to store for this account. |
| `args.profile` | `object` & `Record`\<`string`, `any`\> | The profile data to store for the user. These must fit the `users` table schema. |
| `args.shouldLink` | `boolean` | If `true`, the account will be linked to an existing user with the same email address. |
| `args.emailVerified`? | `boolean` | Whether the email address ownership was already verified. |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<`object`\>

user ID if it successfully creates the account
or throws an error.

#### account


#### user


<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1117](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1117)

***

## retrieveAccountWithCredentials()


Use this function from a `ConvexCredentials` provider
to retrieve a user given a pair of unique account
id and an account secret.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `GenericActionCtx`\<`DataModel`\> | - |
| `args` | `object` | - |
| `args.provider` | `string` | <p>The provider ID (like "password"), used to disambiguate accounts.</p><p>It is also used to configure account secret hashing via the provider's `crypto` option.</p> |
| `args.account` | `object` | - |
| `args.account.id` | `string` | The unique external ID for the account, for example email address. |
| `args.account.secret` | `string` | The secret that should match the stored credential. |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<`object`\>

the retrieved user document, or `null` if there is no account
for given account ID, or throws if the provided
secret does not match.

#### account


#### user


<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1176](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1176)

***

## retrieveAccount()


Use this function from a `ConvexCredentials` provider
to retrieve a user given the account provider ID and
the provider-specific account ID.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `GenericActionCtx`\<`DataModel`\> | - |
| `args` | `object` | - |
| `args.provider` | `string` | <p>The provider ID (like "password"), used to disambiguate accounts.</p><p>It is also used to configure account secret hashing via the provider's `crypto` option.</p> |
| `args.account` | `object` | - |
| `args.account.id` | `string` | The unique external ID for the account, for example email address. |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<`object`\>

the retrieved user document, or `null` if there is no account
for given account ID.

#### account


#### user


<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1220](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1220)

***

## modifyAccountCredentials()


Use this function to modify the account credentials
from a `ConvexCredentials` provider.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type | Description |
| :------ | :------ | :------ |
| `ctx` | `GenericActionCtx`\<`DataModel`\> | - |
| `args` | `object` | - |
| `args.provider` | `string` | <p>The provider ID (like "password"), used to disambiguate accounts.</p><p>It is also used to configure account secret hashing via the `crypto` option.</p> |
| `args.account` | `object` | - |
| `args.account.id` | `string` | The unique external ID for the account, for example email address. |
| `args.account.secret` | `string` | The new secret credential to store for this account. |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<[`GenericDoc`](server.mdx#genericdocdatamodeltablename)\<`DataModel`, `"users"`\>\>

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1256](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1256)

***

## invalidateSessions()


Use this function to invalidate existing sessions.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type |
| :------ | :------ |
| `ctx` | `GenericActionCtx`\<`DataModel`\> |
| `args` | `object` |
| `args.userId` | `Id`\<`"users"`\> |
| `args.except`? | `Id`\<`"sessions"`\>[] |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<[`GenericDoc`](server.mdx#genericdocdatamodeltablename)\<`DataModel`, `"users"`\>\>

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1291](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1291)

***

## signInViaProvider()


Use this function from a `ConvexCredentials` provider
to sign in the user via another provider (usually
for email verification on sign up or password reset).

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Parameters</h3>

| Parameter | Type |
| :------ | :------ |
| `ctx` | [`GenericActionCtxWithAuthConfig`](server.mdx#genericactionctxwithauthconfigdatamodel)\<`DataModel`\> |
| `provider` | `Provider` |
| `signedIn` | `object` |
| `signedIn.accountId` | `Id`\<`"accounts"`\> |

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Returns</h3>

`Promise`\<`null`\>

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/implementation.ts:1314](https://github.com/get-convex/convex-auth/blob/main/src/server/implementation.ts#L1314)

***

## ConvexAuthConfig


The config for the Convex Auth library, passed to `convexAuth`.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Type declaration</h3>

#### providers

> **providers**: `AuthProviderConfig`[]

A list of authentication provider configs.

You can import existing configs from
- `@auth/core/providers/<provider-name>`
- `@xixixao/convex-auth/providers/<provider-name>`

#### theme?

> `optional` **theme**: `Theme`

Theme used for emails.
See [Auth.js theme docs](https://authjs.dev/reference/core/types#theme).

#### session?


Session configuration.

#### session.totalDurationMs?

> `optional` **totalDurationMs**: `number`

How long can a user session last without the user reauthenticating.

Defaults to 30 days.

#### session.inactiveDurationMs?

> `optional` **inactiveDurationMs**: `number`

How long can a user session last without the user being active.

Defaults to 30 days.

#### jwt?


JWT configuration.

#### jwt.durationMs?

> `optional` **durationMs**: `number`

How long is the JWT valid for after it is signed initially.

Defaults to 1 hour.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/types.ts:15](https://github.com/get-convex/convex-auth/blob/main/src/server/types.ts#L15)

***

## GenericActionCtxWithAuthConfig\<DataModel\>


Your `ActionCtx` enriched with `ctx.auth.config` field with
the config passed to `convexAuth`.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Type declaration</h3>

#### auth


#### auth.config


<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/types.ts:63](https://github.com/get-convex/convex-auth/blob/main/src/server/types.ts#L63)

***

## ConvexAuthMaterializedConfig


The config for the Convex Auth library, passed to `convexAuth`,
with defaults and initialized providers.

See [ConvexAuthConfig](server.mdx#convexauthconfig)

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Type declaration</h3>

#### providers


#### theme

> **theme**: `Theme`

#### session?


#### session.totalDurationMs?

> `optional` **totalDurationMs**: `number`

#### session.inactiveDurationMs?

> `optional` **inactiveDurationMs**: `number`

#### jwt?


#### jwt.durationMs?

> `optional` **durationMs**: `number`

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/types.ts:74](https://github.com/get-convex/convex-auth/blob/main/src/server/types.ts#L74)

***

## AuthProviderMaterializedConfig


Materialized Auth.js provider config.

<h3 class="nx-font-semibold nx-tracking-tight nx-text-slate-900 dark:nx-text-slate-100 nx-mt-8 nx-text-2xl">Source</h3>

[src/server/types.ts:89](https://github.com/get-convex/convex-auth/blob/main/src/server/types.ts#L89)
